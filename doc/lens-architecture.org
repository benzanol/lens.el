* Mermaid Diagram
#+begin_src dot :file resources/lens-parts.png :exports results :cmdline -Kdot -Tpng -Gdpi=150
digraph lens {
  graph [bgcolor=white fontname="Helvetica" rankdir=LR pad=0.2 nodesep=0.6 ranksep=0.6]
  node [fontname="Helvetica" fontsize=10 style="rounded,filled" shape=box penwidth=1 width=0.1 height=0.3 margin="0.15,0.08" fontcolor="#1e3a5f"]
  edge [fontname="Helvetica" fontsize=9 arrowsize=0.8 penwidth=1.2 color="#3b82f6" fontcolor="#3b82f6"]

  buffer [label="Buffer" fillcolor="#dbeafe" color="#3b82f6"]
  state [label="State" fillcolor="#dbeafe" color="#3b82f6"]
  text [label="Text" fillcolor="#f3f4f6" color="#6b7280" fontcolor="#374151"]
  datasource [label="Data source" fillcolor="#dcfce7" color="#22c55e" fontcolor="#14532d"]

  text -> state [taillabel=":tostate", labelangle=10, labeldistance=4]
  state -> text [label=":totext"]
  state -> buffer [taillabel=":insert", labelangle=2, labeldistance=7]
  buffer -> state [label="lens-modify (internal)"]

  edge [color="#22c55e" fontcolor="#16a34a"]
  text -> datasource [label=":update, :save"]
  datasource -> text [taillabel="lens-create,\nlens-modify (external)", labelangle=15, labeldistance=5]
}
#+end_src

#+RESULTS:
[[file:resources/lens-parts.png]]

* UML Lifecycle Flow
#+begin_src plantuml :file resources/lens-lifecycle-flow.png :exports results
@startuml
skinparam shadowing false

actor User
participant Lens
participant Source
participant Display
participant "Lens Buffer" as Buffer

== Creation ==
User -> Lens: lens-create(source, display)
activate Lens
Lens -> Source: :init()
Source --> Lens: text
Lens -> Display: :tostate(text)
Display --> Lens: state
Lens -> Display: :insert(state)
Display --> Lens: body
Lens -> Buffer: Insert header + body + footer
deactivate Lens

== Internal Modification ==
User -> Buffer: Interaction with lens (edit text, click button, etc...)
Buffer -> Lens: lens-modify(lens, new-state, internal)
activate Lens
Lens -> Display: :totext(new-state)
Display --> Lens: new-text
Lens -> Display: :insert(new-state)
Display --> Lens: new-body
Lens -> Buffer: Replace lens region
Lens -> Source: :update(new-text)
deactivate Lens

== External Modification ==
User -> Source: Modification to source (buffer, file, network, etc)
Source -> Lens: lens-modify(lens, new-text, external)
activate Lens
Lens -> Display: :tostate(new-text)
Display --> Lens: new-state
Lens -> Display: :insert(new-state)
Display --> Lens: new-insert
Lens -> Buffer: Replace lens region
note right: Do not update source based on new state,\npreventing loop
deactivate Lens

== Removal ==
User -> Lens: lens-remove
activate Lens
Lens -> Source: :replace(text)
Source --> Lens: replacement-text
Lens -> Buffer: Delete lens, insert replacement
deactivate Lens

== Save ==
User -> Buffer: save-buffer
Buffer -> Lens: before-save-hook
activate Lens
Lens -> Source: :replace(text)
Source --> Lens: replacement-text
Lens -> Buffer: Delete lens, insert replacement
deactivate Lens
Buffer -> Buffer: Save buffer (with lens removed)
Buffer -> Lens: after-save-hook
activate Lens
Lens -> Buffer: Reinsert lens
Lens -> Source: :save(text)

@enduml
#+end_src

#+RESULTS:
[[file:resources/lens-lifecycle-flow.png]]

