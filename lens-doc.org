#+TITLE: Lens.el Documentation
#+AUTHOR: Auto-generated
#+DATE: 2026-02-11
#+OPTIONS: toc:3

* Introduction

=lens.el= provides interactive, stateful widgets for Emacs. A *lens* displays content from an external source (buffer, file, or custom) within your buffer, keeping it synchronized with the source.

Key features:
- Embed buffer or file contents inline
- Bidirectional synchronization
- Customizable display and styling
- Folding support
- Undo-friendly architecture

* UML

#+begin_src plantuml :file resources/lens-flow.png :exports results
@startuml
skinparam shadowing false

actor User
participant Lens
participant Source
participant Display
participant Buffer

== Creation ==
User -> Lens: lens-create(source, display)
activate Lens
Lens -> Source: :init()
Source --> Lens: text
Lens -> Display: :tostate(text)
Display --> Lens: state
Lens -> Display: :insert(state)
Display --> Lens: body
Lens -> Buffer: Insert header + body + footer
deactivate Lens

== Internal Modification ==
User -> Buffer: Edit text/click button/etc...
Buffer -> Lens: Modification hook/button callback/etc...
activate Lens
Lens -> Display: :totext(new-state)
Display --> Lens: new-text
Lens -> Display: :insert(new-state)
Display --> Lens: new-body
Lens -> Buffer: Replace lens region
Lens -> Source: :update(new-text)
deactivate Lens

== External Modification ==
User -> Source: Modify source buffer
Source -> Lens: Refresh hook triggers
activate Lens
Lens -> Display: :tostate(new-text)
Display --> Lens: new-state
Lens -> Display: :insert(new-state)
Display --> Lens: new-insert
Lens -> Buffer: Replace lens region
note right: Do not update source based on new state,\npreventing loop
deactivate Lens

== Removal ==
User -> Lens: lens-remove
activate Lens
Lens -> Source: :replace(text)
Source --> Lens: replacement-text
Lens -> Buffer: Delete lens, insert replacement
deactivate Lens

== Save ==
User -> Buffer: save-buffer
Buffer -> Lens: before-save-hook
activate Lens
Lens -> Source: :replace(text)
Source --> Lens: replacement-text
Lens -> Buffer: Delete lens, insert replacement
deactivate Lens
Buffer -> Buffer: Save buffer (with lens removed)
Buffer -> Lens: after-save-hook
activate Lens
Lens -> Buffer: Reinsert lens
Lens -> Source: :save(text)

@enduml
#+end_src

#+RESULTS:
[[file:resources/lens-flow.png]]

* Core Concepts
** What is a Lens?

A lens is a 3-element list: =(SPEC TEXT STATE)=

| Element | Description                                    |
|---------+------------------------------------------------|
| SPEC    | Symbol containing source, display, style info  |
| TEXT    | Raw textual data from the source               |
| STATE   | Processed data derived from text (for display) |

The lens is stored in the buffer via text properties:
- ='lens-begin= on the header
- ='lens-end= on the footer

** Source

A *source* describes where the lens data comes from and how to keep it synchronized.

| Function   | Signature         | Description                        |
|------------+-------------------+------------------------------------|
| =:init=    | =() -> String=    | Get initial text from source       |
| =:update=  | =(text) -> nil=   | Update source when lens modified   |
| =:replace= | =(text) -> String= | Text to insert when lens removed   |
| =:save=    | =(text) -> nil=   | Called when buffer is saved        |
| =:title=   | =() -> String=    | Title shown in lens header         |

** Display

A *display* describes how to convert between text, state, and the displayed output.

| Function   | Signature              | Description                     |
|------------+------------------------+---------------------------------|
| =:tostate= | =(text) -> state=      | Parse text into internal state  |
| =:totext=  | =(state) -> text=      | Convert state back to text      |
| =:insert=  | =(state) -> String=    | Generate the display string     |

** Style

A *style* customizes the visual appearance of the lens.

| Property      | Description                         |
|---------------+-------------------------------------|
| =:face=       | Face for body content               |
| =:head-face=  | Face for header                     |
| =:foot-face=  | Face for footer                     |
| =:props=      | Text properties for body            |
| =:head-props= | Text properties for header          |
| =:foot-props= | Text properties for footer          |

* API Reference
** Creating Lenses
*** lens-create
#+begin_src elisp
(lens-create SOURCE DISPLAY &optional STYLE)
#+end_src

Insert a new lens at point.

- =SOURCE= - Source plist (see [[*Source]])
- =DISPLAY= - Display plist (see [[*Display]])
- =STYLE= - Optional style plist, defaults to =lens-default-style=

*** lens-create-buffer
#+begin_src elisp
(lens-create-buffer BEG END BUFFER)
#+end_src

Create a lens displaying =BUFFER=, replacing region from =BEG= to =END=.

*** lens-create-file
#+begin_src elisp
(lens-create-file BEG END FILE)
#+end_src

Create a lens displaying =FILE=, replacing region from =BEG= to =END=.

*** lens-create-new-file
#+begin_src elisp
(lens-create-new-file PATH)
#+end_src

Create a new file at =PATH= and insert a lens displaying it.

** Modifying Lenses
There are two types of modifies: external and internal modifies. An external modify is when the lens source is changed, which triggers a change in the text, regenerating the lens state from the new text. An internal modify is when the lens contents is changed, which triggers a change in the state, from which the new text is generated, eventually propagating to a change in the source.

*** lens-modify
#+begin_src elisp
(lens-modify REGION NEW &optional EXTERNAL NOREFRESH)
#+end_src

Update the lens at =REGION= with new data =NEW=.

- =REGION= - Result from =lens-at-point= or =lens-search-forward=
- =NEW= - New state (or text if =EXTERNAL= is t)
- =EXTERNAL= - If t, =NEW= is text from external source
- =NOREFRESH= - If t, only update headers; if function, use as renderer

** Removing Lenses
*** lens-remove
#+begin_src elisp
(lens-remove REGION)
#+end_src

Remove the lens at =REGION=.

*** lens-remove-all
#+begin_src elisp
(lens-remove-all)
#+end_src

Remove all lenses in the current buffer.

** Finding Lenses
*** lens-at-point
#+begin_src elisp
(lens-at-point &optional NOERROR) -> (LENS HB HE FB FE)
#+end_src

Return the lens region containing point.

Returns a list:
- =LENS= - The lens tuple =(SPEC TEXT STATE)=
- =HB=, =HE= - Header beginning and end
- =FB=, =FE= - Footer beginning and end

*** lens-search-forward
#+begin_src elisp
(lens-search-forward &optional VAL PRED) -> (LENS HB HE FB FE)
#+end_src

Search forward for a lens. =VAL= and =PRED= work like =text-property-search-forward=.

** Folding
*** lens-fold / lens-unfold
#+begin_src elisp
(lens-fold REGION)
(lens-unfold LENS)
#+end_src

Fold or unfold a lens.

*** lens-fold-toggle
#+begin_src elisp
(lens-fold-toggle REGION)
#+end_src

Toggle fold state of lens at =REGION=.

*** lens-fold-all / lens-unfold-all
#+begin_src elisp
(lens-fold-all)
(lens-unfold-all)
#+end_src

Fold or unfold all lenses in buffer.

** Built-in Sources

*** lens-replace-source
#+begin_src elisp
(lens-replace-source STR &optional BEFORE AFTER)
#+end_src

Simple source that wraps text with =BEFORE= and =AFTER= on removal.

*** lens-buffer-source
#+begin_src elisp
(lens-buffer-source BUF &optional REPLACED)
#+end_src

Source referencing buffer =BUF=. Changes to the buffer update all lenses referencing it.

*** lens-file-source
#+begin_src elisp
(lens-file-source FILE &optional REPLACED)
#+end_src

Source referencing =FILE=. Integrates with =find-file-hook= for synchronization.

** Built-in Displays

*** lens-raw-display
#+begin_src elisp
(lens-raw-display &optional FORWARD-FILTER BACKWARD-FILTER)
#+end_src

Display text verbatim in an editable field.

- =FORWARD-FILTER= - Transform text before display
- =BACKWARD-FILTER= - Transform display back to text

* Auto Mode

=lens-auto-mode= automatically creates lenses based on patterns.

** Configuration

Set =lens-auto-matchers= to an alist of =(REGEXP . FUNCTION)=.

The default =lens-auto-mode-alist= provides matchers per major mode:
#+begin_src elisp
(setq lens-auto-mode-alist
      `((org-mode . ,lens-auto-matchers:org-mode)))
#+end_src

** Org Mode Support

In org-mode, file links followed by a newline become lenses:

#+begin_example
[[./myfile.txt]]
#+end_example

This is converted to a lens displaying =myfile.txt=.

* Customization

** Variables

| Variable                    | Default | Description                        |
|-----------------------------+---------+------------------------------------|
| =lens-catch-display-errors= | t       | Catch and display errors           |
| =lens-save-lenses-on-save=  | t       | Save sources when buffer saved     |
| =lens-default-style=        | box     | Default visual style               |

** Faces

| Face                | Description              |
|---------------------+--------------------------|
| =lens-box-body=     | Body background          |
| =lens-box-head=     | Header styling           |
| =lens-box-foot=     | Footer styling           |
| =lens-box-vert=     | Vertical border line     |
| =lens-box-overline= | Top border               |
| =lens-box-underline= | Bottom border            |
| =lens-field-header= | Field delimiter styling  |

** Box Style Variables

| Variable           | Default | Description               |
|--------------------+---------+---------------------------|
| =lens-box-margin=  | 5       | Margin outside border     |
| =lens-box-padding= | 8       | Padding inside border     |

* Examples

** Basic File Lens

#+begin_src elisp
;; Create a lens showing a file
(lens-create (lens-file-source "~/notes.txt")
             (lens-raw-display))
#+end_src

** Buffer Lens

#+begin_src elisp
;; Create a lens showing a buffer
(lens-create (lens-buffer-source "*scratch*")
             (lens-raw-display))
#+end_src

** Custom Source

#+begin_src elisp
;; Create a read-only lens with custom source
(defvar my-data "Hello, World!")

(lens-create
 (list :init (lambda () my-data)
       :update (lambda (text) (setq my-data text))
       :replace (lambda (_) ""))
 (lens-raw-display))
#+end_src

** Custom Display

#+begin_src elisp
;; Create a lens that displays text in uppercase
(lens-create
 (lens-file-source "~/data.txt")
 (list :tostate #'upcase
       :totext #'downcase
       :insert (lambda (state)
                 (concat "\n" state "\n"))))
#+end_src

* Internals

** Save Mechanism

When saving a buffer with lenses:

1. =lens--before-save= stores buffer state
2. All lenses are removed (replaced with =:replace= text)
3. Buffer is saved to disk
4. =lens--after-save-once= restores lenses

This ensures the saved file doesn't contain lens markup.

** Synchronization

Buffer/file sources maintain reference lists:

- =lens--buffer-referencers= - Per-buffer list of referring lens buffers
- =lens--file-referencers= - Global alist of files to lens buffers

When a source is modified, all lenses are updated via =lens--refresh-buffer-referencers=.

** Field System

Editable regions use the field system (=lens--field=):

1. Creates a region with read-only header/footer
2. Modification hooks track changes
3. Changes batched via =lens--modified-fields=
4. =post-command-hook= processes changes and calls =onchange=
